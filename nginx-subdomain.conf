# ===================================================================
# Nginx Configuration for JGM Live Captions with Subdomain Setup
# ===================================================================
#
# This configuration sets up two subdomains:
# 1. Admin subdomain (e.g., admin.yourchurch.com) - Full control panel
# 2. Audience subdomain (e.g., translate.yourchurch.com) - Public viewer
#
# Installation:
# 1. Copy this file to /etc/nginx/sites-available/jgm-captions
# 2. Update the server_name values with your actual domains
# 3. Create symlink: sudo ln -s /etc/nginx/sites-available/jgm-captions /etc/nginx/sites-enabled/
# 4. Test config: sudo nginx -t
# 5. Reload nginx: sudo systemctl reload nginx
# 6. Setup SSL: sudo certbot --nginx -d admin.yourchurch.com -d translate.yourchurch.com
#
# Note: Token system removed - audience endpoint is now public at /audience
#
# ===================================================================

# ===== AUDIENCE SUBDOMAIN (Public) =====
# This is the public-facing translation viewer for church members
# Clean URL, no access to admin features

server {
    listen 80;
    listen [::]:80;
    server_name translate.yourchurch.com;  # ⚠️ CHANGE THIS to your actual domain
    
    # Redirect HTTP to HTTPS (after SSL is set up)
    # Uncomment these lines after running certbot:
    # return 301 https://$server_name$request_uri;
    
    # ===== Audience Page =====
    location / {
        # Simple proxy to /audience endpoint (no token needed)
        proxy_pass http://localhost:8080/audience;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts for long-lived connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;  # 5 minutes for SSE
    }
    
    # ===== Audience SSE Stream =====
    location /audience/stream {
        proxy_pass http://localhost:8080/audience/stream;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE-specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;  # Keep connection alive
        chunked_transfer_encoding on;
        
        # CORS headers (if needed)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Cache-Control' 'no-cache' always;
    }
    
    # Block access to admin pages from audience subdomain
    location ~ ^/(client|transcript|logs|api) {
        return 404;
    }
}

# ===== ADMIN SUBDOMAIN (Protected) =====
# This is your control panel with full access to all features

server {
    listen 80;
    listen [::]:80;
    server_name admin.yourchurch.com;  # ⚠️ CHANGE THIS to your actual domain
    
    # Redirect HTTP to HTTPS (after SSL is set up)
    # Uncomment these lines after running certbot:
    # return 301 https://$server_name$request_uri;
    
    # Optional: IP whitelist for extra security
    # Uncomment and add your IP addresses:
    # allow YOUR.HOME.IP.ADDRESS;
    # allow YOUR.CHURCH.IP.ADDRESS;
    # deny all;
    
    # ===== Main Admin Page =====
    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ===== WebSocket Endpoints =====
    location ~ ^/(client|captions)$ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # WebSocket timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # ===== SSE Endpoints (Logs, Transcript) =====
    location ~ ^/(logs/stream|transcript/stream)$ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE-specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
        chunked_transfer_encoding on;
    }
    
    # ===== API Endpoints =====
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ===== Static Pages =====
    location ~ ^/(transcript|logs|captions)$ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===== HTTPS CONFIGURATION (After SSL Setup) =====
# After running certbot, it will automatically add HTTPS server blocks here
# The configuration will look similar to the HTTP blocks above but with SSL certificates

# Example HTTPS block (certbot will generate this):
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name translate.yourchurch.com;
#     
#     ssl_certificate /etc/letsencrypt/live/translate.yourchurch.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/translate.yourchurch.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#     
#     # ... rest of configuration ...
# }

# ===================================================================
# ALTERNATIVE: Single Domain with Path-Based Routing
# ===================================================================
# If you can't set up subdomains, use this configuration instead:
#
# server {
#     listen 80;
#     server_name yourchurch.com;
#     
#     # Audience page (public)
#     location /jgmtranslate {
#         set $audience_token "YOUR_AUDIENCE_TOKEN_HERE";
#         proxy_pass http://localhost:8080/audience/$audience_token;
#         # ... proxy settings ...
#     }
#     
#     # Admin pages (consider adding password protection)
#     location / {
#         # Optional: Basic auth
#         # auth_basic "Admin Access";
#         # auth_basic_user_file /etc/nginx/.htpasswd;
#         
#         proxy_pass http://localhost:8080;
#         # ... proxy settings ...
#     }
# }
#
# To create password file:
# sudo apt install apache2-utils
# sudo htpasswd -c /etc/nginx/.htpasswd admin
# ===================================================================

